<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>html5 | Jamescain Blog</title>
    <meta name="description" content="A knowledge blog">
    <link rel="icon" href="/My-lab/favicon.ico">
    
    <link rel="preload" href="/My-lab/assets/css/styles.e689323a.css" as="style"><link rel="preload" href="/My-lab/assets/js/app.e689323a.js" as="script"><link rel="preload" href="/My-lab/assets/js/14.7df31e72.js" as="script"><link rel="prefetch" href="/My-lab/assets/css/1.styles.b05fc641.css"><link rel="prefetch" href="/My-lab/assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="/My-lab/assets/js/1.b05fc641.js"><link rel="prefetch" href="/My-lab/assets/js/10.1733474b.js"><link rel="prefetch" href="/My-lab/assets/js/11.89ea83ca.js"><link rel="prefetch" href="/My-lab/assets/js/12.e022df96.js"><link rel="prefetch" href="/My-lab/assets/js/13.94526f52.js"><link rel="prefetch" href="/My-lab/assets/js/15.d1b7129e.js"><link rel="prefetch" href="/My-lab/assets/js/16.a0280370.js"><link rel="prefetch" href="/My-lab/assets/js/17.f81a4d4c.js"><link rel="prefetch" href="/My-lab/assets/js/18.80ecd1c2.js"><link rel="prefetch" href="/My-lab/assets/js/19.249ddb74.js"><link rel="prefetch" href="/My-lab/assets/js/2.a2bd3099.js"><link rel="prefetch" href="/My-lab/assets/js/20.794d3e11.js"><link rel="prefetch" href="/My-lab/assets/js/21.dbea711f.js"><link rel="prefetch" href="/My-lab/assets/js/22.3091c34f.js"><link rel="prefetch" href="/My-lab/assets/js/23.c47e727f.js"><link rel="prefetch" href="/My-lab/assets/js/24.2f945c2c.js"><link rel="prefetch" href="/My-lab/assets/js/25.919977e7.js"><link rel="prefetch" href="/My-lab/assets/js/26.47fff9c3.js"><link rel="prefetch" href="/My-lab/assets/js/27.21a8f69f.js"><link rel="prefetch" href="/My-lab/assets/js/28.82500f23.js"><link rel="prefetch" href="/My-lab/assets/js/29.799dbfb7.js"><link rel="prefetch" href="/My-lab/assets/js/3.3a18354b.js"><link rel="prefetch" href="/My-lab/assets/js/30.d59e5bf4.js"><link rel="prefetch" href="/My-lab/assets/js/31.714fd27b.js"><link rel="prefetch" href="/My-lab/assets/js/32.d8698e0e.js"><link rel="prefetch" href="/My-lab/assets/js/33.e7942452.js"><link rel="prefetch" href="/My-lab/assets/js/4.13e7e4d8.js"><link rel="prefetch" href="/My-lab/assets/js/5.d37f1fd9.js"><link rel="prefetch" href="/My-lab/assets/js/6.3c9a61eb.js"><link rel="prefetch" href="/My-lab/assets/js/7.7b80c67e.js"><link rel="prefetch" href="/My-lab/assets/js/8.e6c1bf04.js"><link rel="prefetch" href="/My-lab/assets/js/9.b6b98d8d.js">
    <link rel="stylesheet" href="/My-lab/assets/css/1.styles.b05fc641.css"><link rel="stylesheet" href="/My-lab/assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="/My-lab/assets/css/styles.e689323a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/My-lab/" class="home-link router-link-active"><!----> <span class="site-name">Jamescain Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/My-lab/knowledge/" class="nav-link router-link-active">知识库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://twitter.com/Jamescain_lll" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者twitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/james-cain/My-lab" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/My-lab/knowledge/" class="nav-link router-link-active">知识库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://twitter.com/Jamescain_lll" target="_blank" rel="noopener noreferrer" class="nav-link external">
  作者twitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/james-cain/My-lab" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>基础</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/My-lab/knowledge/Damn-hole-of-html5.html" class="active sidebar-link">html5</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#web通信" class="sidebar-link">web通信</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#message事件" class="sidebar-link">Message事件</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#跨文档通信" class="sidebar-link">跨文档通信</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#通道通信" class="sidebar-link">通道通信</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#input重复上传同一文件问题" class="sidebar-link">Input重复上传同一文件问题</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#img-srcset-sizes" class="sidebar-link">Img srcset/sizes</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#execcommand" class="sidebar-link">execCommand</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#notification" class="sidebar-link">notification</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#pushmanager" class="sidebar-link">pushManager</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#serviceworker" class="sidebar-link">ServiceWorker</a></li><li class="sidebar-sub-header"><a href="/My-lab/knowledge/Damn-hole-of-html5.html#appmanifest" class="sidebar-link">appmanifest</a></li></ul></li><li><a href="/My-lab/knowledge/Damn-hole-of-CSS3.html" class="sidebar-link">CSS3</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-javascript.html" class="sidebar-link">JavaScript</a></li><li><a href="/My-lab/knowledge/review-the-javascript.html" class="sidebar-link">ES6</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-http.html" class="sidebar-link">http/http2/https</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>进阶</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/My-lab/knowledge/Damn-hole-of-common-plugin.html" class="sidebar-link">常用插件包问题</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-Browser.html" class="sidebar-link">Browser</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-IE9.html" class="sidebar-link">IE9 兼容性</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-mobile-compatibility.html" class="sidebar-link">mobile 兼容性</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-google-devtools.html" class="sidebar-link">google devtools</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-network.html" class="sidebar-link">网络</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-safe-and-hacker.html" class="sidebar-link">网络安全</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-javascript-algonithms.html" class="sidebar-link">JavaScript算法</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-performance.html" class="sidebar-link">性能优化</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-the-EST.html" class="sidebar-link">EST</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-the-web-worker.html" class="sidebar-link">web-worker</a></li><li><a href="/My-lab/knowledge/parameters-of-package.html" class="sidebar-link">详解package.json</a></li><li><a href="/My-lab/knowledge/Advanced.html" class="sidebar-link">进阶学习</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>工具</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/My-lab/knowledge/Damn-hole-of-babel.html" class="sidebar-link">babel7</a></li><li><a href="/My-lab/knowledge/webpack-perf.html" class="sidebar-link">Webpack打包优化</a></li><li><a href="/My-lab/knowledge/webpack-source-learning.html" class="sidebar-link">webpack源码</a></li><li><a href="/My-lab/knowledge/how-to-use-npm-sonatype.html" class="sidebar-link">用sonatype3搭建npm私服</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>拓展</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/My-lab/knowledge/Damn-hole-of-pwa.html" class="sidebar-link">PWA</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-electron.html" class="sidebar-link">electron</a></li><li><a href="/My-lab/knowledge/how-to-learn-ionic.html" class="sidebar-link">ionic</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>源码分析</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/My-lab/knowledge/Damn-hole-of-mvvm.html" class="sidebar-link">MVVM</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-React.html" class="sidebar-link">React</a></li><li><a href="/My-lab/knowledge/Damn-hole-of-Vue.html" class="sidebar-link">Vue</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/My-lab/knowledge/server-record.html" class="sidebar-link">部署一台属于自己的服务器</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="html5"><a href="#html5" aria-hidden="true" class="header-anchor">#</a> html5</h1> <h2 id="web通信"><a href="#web通信" aria-hidden="true" class="header-anchor">#</a> web通信</h2> <p>web通信，实际有两个略不同的系统，<strong>跨文档通信(cross-document messaging)<strong>和</strong>通道通信(channel messaging)</strong>。</p> <p>无论是跨文档通信（cross-document messaging）、通道通信（channel messaging）、服务器发送事件（server-sent events）或是网络套接字（web sockets）都要执行<strong>message事件</strong></p> <h2 id="message事件"><a href="#message事件" aria-hidden="true" class="header-anchor">#</a> Message事件</h2> <p>包含5个只读属性</p> <table><thead><tr><th>属性名</th> <th>含义</th></tr></thead> <tbody><tr><td>data</td> <td>包含任意字符串数据，由原始脚本发送</td></tr> <tr><td>origin</td> <td>一个字符串，包含原始文档的方案、域名以及端口</td></tr> <tr><td>lastEventId</td> <td>一个字符串，包含了当前的消息事件的唯一标识符</td></tr> <tr><td>source</td> <td>原始文件的窗口的引用</td></tr> <tr><td>ports</td> <td>一个数组，包含任何MessagePort对象发送消息</td></tr></tbody></table> <p>在跨文档通信和通道通信中，lastEventId的值一般为空字符串；lastEventId应用在服务器端发送事件上。</p> <p>发送消息中如果没有ports，则ports属性值就是个长度为0的数组</p> <p>MessageEvent继承DOM事件接口，且属性共享。然而，<strong>通信事件并没有冒泡，不能取消，也没有默认行为</strong></p> <h2 id="跨文档通信"><a href="#跨文档通信" aria-hidden="true" class="header-anchor">#</a> 跨文档通信</h2> <p>IE8+浏览器支持</p> <p>发送核心JS代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>
</code></pre></div><p>postMessage方法支持两个参数</p> <table><thead><tr><th>参数</th> <th>含义</th></tr></thead> <tbody><tr><td>message</td> <td>发送的数据</td></tr> <tr><td>targetOrigin</td> <td>发送数据的来源</td></tr></tbody></table> <p>postMessage中的message参数不仅仅可以是字符串，结构对象、数据对象（如：File和ArrayBuffer）或是数组</p> <p>但<strong>IE8/IE9/FireFox3.6只支持字符串数据</strong></p> <p>targetOrigin *<strong><strong>-&gt;接收任何目标来源 <strong>/</strong> -&gt; 限制信息只能同源发送。注意在指定来源的时候，后面</strong>不要带斜杆</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'发送消息'</span><span class="token punctuation">,</span> <span class="token string">'http://example.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 而不是</span>
window<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'发送消息'</span><span class="token punctuation">,</span> <span class="token string">'http://example.com/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="通道通信"><a href="#通道通信" aria-hidden="true" class="header-anchor">#</a> 通道通信</h2> <p>消息通道提供了一个直接，双向浏览上下文之间的通信手段。管道每端为端口，数据从一个端口发送，另一个变成输入</p> <p>##MessageChannel和MessagePort对象</p> <p>创建一个MessageChannel对象，实际上创造了两个相互关联的端口。一个端口保持开放，为发送端。另外一个被转发到其他浏览上下文</p> <p>MessagePort，包含三个可用方法</p> <table><thead><tr><th>方法名</th> <th>含义</th></tr></thead> <tbody><tr><td>postMessage()</td> <td>通过通道发送消息</td></tr> <tr><td>start()</td> <td>开始在端口上分派接受的信息</td></tr> <tr><td>close()</td> <td>关闭端口</td></tr></tbody></table> <p>MessagePort对象还有onmessage事件属性，可被用来定义事件句柄而不是事件监听</p> <h3 id="实例"><a href="#实例" aria-hidden="true" class="header-anchor">#</a> 实例</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 本例组成由 主页面+内部嵌套两个iframe页面(iframe1和iframe2)</span>
<span class="token comment">// 首先是第一个iframe页面(称为iframe1)，主要完成任务为实现表单提交，通知另外一个iframe页(称为iframe2)，在iframe2中展现。在做表单提交前，需要先通知主页面已经加载好；并且接受来自主页面的传递进来的端口信息</span>
<span class="token keyword">var</span> eleForm <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">;</span>
eleForm<span class="token punctuation">.</span><span class="token function-variable function">onsubmit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> documenet<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;input[type='test']&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>port <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>'信息发送失败，目前没有可用的端口&quot;<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// postMessage为主页面中发送</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>origin <span class="token operator">===</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            port <span class="token operator">=</span> evt<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">alert</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>origin <span class="token operator">+</span> <span class="token string">'来源不认识'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'iframe1页加载完毕'</span><span class="token punctuation">,</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 右边iframe2页主要接收来自iframe1发送的信息，并展示。</span>
<span class="token comment">// 主要完成任务，一是创建MessageChannel通道对象，二是告诉主页面，加载完了，并把端口传过去，三是显示发送过来的信息</span>
<span class="token keyword">var</span> eleBox <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#message'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">messageHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eleBox<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'接收到的信息是'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>MessageChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建一个新的MessageChannel对象</span>
        <span class="token keyword">var</span> mc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 给父级发送一个端口</span>
        window<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'iframe2页加载完毕'</span><span class="token punctuation">,</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>mc<span class="token punctuation">.</span>port1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 显示发送的信息</span>
        mc<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> messageHandler<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mc<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        eleBox<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'浏览器不支持通道通信'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 主页面主要是做将iframe2中的通道端口传递到iframe1，让两个iframe打通</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>evt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>origin <span class="token operator">===</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>evt<span class="token punctuation">.</span>ports<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将端口转移到iframe1文档</span>
            window<span class="token punctuation">.</span>frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'端口打开'</span><span class="token punctuation">,</span> <span class="token string">'https://coracain.com'</span><span class="token punctuation">,</span> evt<span class="token punctuation">.</span>ports<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="input重复上传同一文件问题"><a href="#input重复上传同一文件问题" aria-hidden="true" class="header-anchor">#</a> Input重复上传同一文件问题</h2> <p>input[type=file]使用的是onchange，onchange监听的为input的value值，只有在内容发生改变的时候去触发，而value在上传文件的时候保存的是文件的内容，只需要在上传成功的回调里面，将当前input的value值置空即可。</p> <div class="language- extra-class"><pre class="language-text"><code>event.target.value= '';
</code></pre></div><h2 id="img-srcset-sizes"><a href="#img-srcset-sizes" aria-hidden="true" class="header-anchor">#</a> Img srcset/sizes</h2> <h2 id="execcommand"><a href="#execcommand" aria-hidden="true" class="header-anchor">#</a> execCommand</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 探测浏览器是否支持copy命令</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>document<span class="token punctuation">.</span>queryCommandSupported <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">queryCommandSupported</span><span class="token punctuation">(</span><span class="token string">'copy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 复制指定文本信息</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">copy</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fakeElem <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'textarea'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">'absolute'</span><span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token string">'-9999px'</span><span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'readonly'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span>value <span class="token operator">=</span> text<span class="token punctuation">;</span>
  fakeElem<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'copy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    fakeElem<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fakeElem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="notification"><a href="#notification" aria-hidden="true" class="header-anchor">#</a> notification</h2> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>notifyMe()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Notify me!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">notifyMe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先检查浏览器是否支持</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&quot;Notification&quot;</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;This browser does not support desktop notification&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 检查用户是否同意接受通知</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">&quot;granted&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token string">&quot;Hi there!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 否则需要向用户获取权限</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">&quot;denied&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果用户统一，就可以向他们发送通知</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>permission <span class="token operator">===</span> <span class="token string">&quot;granted&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token string">&quot;Hi there!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="pushmanager"><a href="#pushmanager" aria-hidden="true" class="header-anchor">#</a> pushManager</h2> <p>浏览器实现消息推送，和native app一样，依赖于推送服务。是服务器、浏览器和推送服务三者之间进行的。首先要使用Notification.requestPermission 让用户授权，只有允许后，才会向浏览器推送服务。</p> <p>订阅服务过程，服务端需要一个唯一标识的身份区分不同的浏览器。由服务器端使用web-push生成<strong>applicationServerKey</strong>，这个key存在公钥和私钥，都需要转换成<code>UInt8Array</code>格式，公钥用于浏览器向推送服务发送请求，获取对应的PushSubscription(推送订阅对象)，再将该对象发送给服务器存储。完整的推送订阅对象结构如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;endpoint&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;https://fcm.googleapis.com/fcm/send/...&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;keys&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;p256dh&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;BNcRd...&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;auth&quot;</span>   <span class="token punctuation">:</span> <span class="token string">&quot;tBHI...&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中<code>endpoint</code>就是推送服务返回的唯一标识用户设备的地址，而<code>keys</code>是浏览器预先生成的，包含了用于安全验证信息</p> <p>###第一步，订阅消息的具体实现步骤如下：</p> <ol><li>注册 Service Worker</li> <li>使用 pushManager 添加订阅，浏览器向推送服务发送请求，其中传递参数对象包含两个属性：
<ul><li><code>userVisibleOnly</code>，不允许静默的推送，所有推送都对用户可见，所以值为<code>true</code></li> <li><code>applicationServerKey</code>，服务器生成的公钥</li></ul></li> <li>得到推送服务成功响应后，浏览器将推送服务返回的 endpoint 加入推送订阅对象，向服务器发送这个对象供其存储</li></ol> <p>具体代码实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将base64的applicationServerKey转换成UInt8Array</span>
<span class="token keyword">function</span> <span class="token function">urlBase64ToUint8Array</span><span class="token punctuation">(</span>base64String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> padding <span class="token operator">=</span> <span class="token string">'='</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">-</span> base64String<span class="token punctuation">.</span>length <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> base64 <span class="token operator">=</span> <span class="token punctuation">(</span>base64String <span class="token operator">+</span> padding<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\-/g</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/_/g</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> rawData <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">atob</span><span class="token punctuation">(</span>base64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> outputArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>rawData<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> max <span class="token operator">=</span> rawData<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        outputArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> rawData<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> outputArray<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>serviceWorkerReg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    serviceWorkerReg<span class="token punctuation">.</span>pushManager<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 2.订阅</span>
    	userVisibleOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    	appliactionServerKey<span class="token punctuation">:</span> <span class="token function">urlBase64ToUint8Array</span><span class="token punctuation">(</span><span class="token string">'&lt;applicationServerKey&gt;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3.发送推送订阅对象到服务器，具体实现中发送请求到后端api</span>
        <span class="token function">sendEndPointInSubscription</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Notifacation<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">'denied'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 用户拒绝了订阅请求</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator <span class="token operator">&amp;&amp;</span> <span class="token string">'PushManager'</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1.注册service worker</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">subscribe</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>取消订阅：</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>reg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    reg<span class="token punctuation">.</span>pushManager<span class="token punctuation">.</span><span class="token function">getSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subscription<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>successful<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>推送服务的响应</p> <p>接下来，服务端可以向endpoint发送包含以上请求头的请求了，推送服务响应<code>201</code>标识接受调用。其余响应状态码如下：</p> <ul><li>429 Too many requests</li> <li>400 Invalid request</li> <li>404 Not Found 订阅过期，需要在服务端删除保存的推送订阅对象</li> <li>410 Gone 订阅失效，需要在服务端删除保存的推送订阅对象，并调用推送订阅对象的<code>unsubscribe()</code>方法</li> <li>413 Payload size too large</li></ul> <p>###第二步，使用web-push发送消息</p> <p><a href="https://github.com/web-push-libs/web-push" target="_blank" rel="noopener noreferrer">web-push<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>可以帮助生成公私钥，用<code>setVapidDetail</code>设置公私钥，并且调用<code>sendNotification</code>可以向推送服务发起调用请求，根据返回状态码做响应操作</p> <p>具体实现可以如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> webpush <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'web-push'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> vapidKeys <span class="token operator">=</span> webpush<span class="token punctuation">.</span><span class="token function">generateVAPIDKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1. 生成公私钥</span>
webpush<span class="token punctuation">.</span><span class="token function">setVapidDetails</span><span class="token punctuation">(</span> <span class="token comment">// 2.设置公私钥</span>
	<span class="token string">'mailto:sender@example.com'</span><span class="token punctuation">,</span>
	vapidKeys<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span>
	vapidKeys<span class="token punctuation">.</span>privateKey
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3.从数据库中拿出之前保存的pushSubscription</span>
<span class="token comment">// 4.向推送服务发起调用请求</span>
webpush<span class="token punctuation">.</span><span class="token function">sendNotification</span><span class="token punctuation">(</span>pushSubscription<span class="token punctuation">,</span> <span class="token string">'推送消息内容'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>statusCode <span class="token operator">===</span> <span class="token number">410</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从数据库中删除推送订阅对象</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="第三步，显示通知"><a href="#第三步，显示通知" aria-hidden="true" class="header-anchor">#</a> 第三步，显示通知</h3> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> promiseChain <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>promiseChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="serviceworker"><a href="#serviceworker" aria-hidden="true" class="header-anchor">#</a> ServiceWorker</h2> <p>service worker属于 <a href="https://html.spec.whatwg.org/multipage/workers.html#workers" target="_blank" rel="noopener noreferrer">web worker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>一类。service worker会在注册service worker client的源上执行。</p> <p>service worker包括一些state，如parsed、installing、installed、activating、activated和redundant。初始化于parsed</p> <p>service worker关联包含自己的注册表（<a href="https://w3c.github.io/ServiceWorker/#dfn-service-worker-registration" target="_blank" rel="noopener noreferrer">service worker registration<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p> <p>Service worker带有一个全局对象（<a href="https://w3c.github.io/ServiceWorker/#serviceworkerglobalscope" target="_blank" rel="noopener noreferrer">ServiceWorkerGlobalScope<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p> <h3 id="service-worker-registration"><a href="#service-worker-registration" aria-hidden="true" class="header-anchor">#</a> Service Worker Registration</h3> <p>包括scope url和一组service workers:installing worker（状态为installing 或null）、waiting worker（状态为installed或null）、active worker（状态为activating、activated或null）</p> <p>包括最新更新检测时间(last update check time)，默认为null</p> <p>通过cache mode来更新，包括imports、all或none，默认为imports</p> <p>包括uninstalling flag，默认不设置</p> <p>包括<a href="https://w3c.github.io/ServiceWorker/#navigationpreloadmanager" target="_blank" rel="noopener noreferrer">NavigationPerloadManager<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对象</p> <p>包括navigation preload enabled标记，默认不设置</p> <p>包括navigation preload header值，默认为true</p> <h3 id="service-worker-client"><a href="#service-worker-client" aria-hidden="true" class="header-anchor">#</a> Service Worker Client</h3> <p>Service worker client是一个环境。service worker client有一个相关联的废弃标志，默认不设置。</p> <p>如果sevice worker client是环境设置对象，那么它有一个定义返回service worker client源的算法；否则将返回service worker client创建URL源的地址</p> <p>window client：全局对象是Window对象的service worker client</p> <p>dedicated worker client：全局对象是<a href="https://html.spec.whatwg.org/multipage/workers.html#dedicatedworkerglobalscope" target="_blank" rel="noopener noreferrer">DedicatedWorkerGlobalScope<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对象的service worker client</p> <p>shared worker client：全局对象是<a href="https://html.spec.whatwg.org/multipage/workers.html#sharedworkerglobalscope" target="_blank" rel="noopener noreferrer">SharedWorkerGlobalScope<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对象的service worker client</p> <p>worker client：dedicated worker client和shared worker client</p> <p>service worker client选择并使用service worker registration来进行对自己和子资源的加载。依靠对非子资源请求来对service worker registration选择，是匹配service worker registration从scope改变成注册映射的过程。</p> <p>当请求的url不是本地时，service worker client从scope到注册映射匹配service worker registration。也就是说，service worker client视图尝试咨询service worker registration--将scope url和创建URL相匹配。</p> <p>如果匹配成功，被选择的service worker registration的激活worker将开始控制service worker client。否则，将返回到默认行为的位置。</p> <h3 id="client-context"><a href="#client-context" aria-hidden="true" class="header-anchor">#</a> Client Context</h3> <h4 id="serviceworker-2"><a href="#serviceworker-2" aria-hidden="true" class="header-anchor">#</a> ServiceWorker</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface ServiceWorker : EventTarget {
  readonly attribute USVString scriptURL;
  readonly attribute ServiceWorkerState state;
  void postMessage(any message, optional sequence&lt;object&gt; transfer = []);

  // event
  attribute EventHandler onstatechange;
};
ServiceWorker includes AbstractWorker;

enum ServiceWorkerState {
  &quot;installing&quot;,
  &quot;installed&quot;,
  &quot;activating&quot;,
  &quot;activated&quot;,
  &quot;redundant&quot;
};
</code></pre></div><p>该对象会在<code>ServiceWorkerRegistration.active</code>属性和<code>ServiceWorkerContainer.controller</code>属性中可用，它是一个激活并在控制页面的serviceWorker</p> <p>包括scriptURL和state两个只读属性。scriptURL必须和注册该ServiceWorker的文档处在同一域，state值可以为installing、installed、activating、activated或redundant</p> <ul><li><p>scriptURL</p> <div class="language- extra-class"><pre class="language-text"><code>// script放在https://example.com/app.html下
navigator.serviceWorker.register('/service_worker.js');
// 注册完成后,通过navigator.serviceWorker.controller.scriptURL返回的值为&quot;https://example.com/service_worker.js&quot;
</code></pre></div></li> <li><p>state</p> <p>返回的值为ServiceWorkerState(installing,installed,activating,activated,redundant)之一</p></li> <li><p>postMessage(message, transfer)</p></li></ul> <h4 id="serviceworkerregistration"><a href="#serviceworkerregistration" aria-hidden="true" class="header-anchor">#</a> ServiceWorkerRegistration</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface ServiceWorkerRegistration : EventTarget {
  readonly attribute ServiceWorker? installing;
  readonly attribute ServiceWorker? waiting;
  readonly attribute ServiceWorker? active;
  [SameObject] readonly attribute NavigationPreloadManager navigationPreload;

  readonly attribute USVString scope;
  readonly attribute ServiceWorkerUpdateViaCache updateViaCache;

  [NewObject] Promise&lt;void&gt; update();
  [NewObject] Promise&lt;boolean&gt; unregister();

  // event
  attribute EventHandler onupdatefound;
};

enum ServiceWorkerUpdateViaCache {
  &quot;imports&quot;,
  &quot;all&quot;,
  &quot;none&quot;
};
</code></pre></div><ul><li><p>scope</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 以上面scriptURL为例</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>registration <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>registration<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// https://exmaple.com/</span>
</code></pre></div></li></ul> <h4 id="navigator-serviceworker"><a href="#navigator-serviceworker" aria-hidden="true" class="header-anchor">#</a> navigator.serviceWorker</h4> <div class="language-c# extra-class"><pre class="language-text"><code>partial interface Navigator {
  [SecureContext, SameObject] readonly attribute ServiceWorkerContainer serviceWorker;
};

partial interface WorkerNavigator {
  [SecureContext, SameObject] readonly attribute ServiceWorkerContainer serviceWorker;
};
</code></pre></div><p>返回ServiceWorkerContainer对象</p> <h4 id="serviceworkercontainer"><a href="#serviceworkercontainer" aria-hidden="true" class="header-anchor">#</a> ServiceWorkerContainer</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface ServiceWorkerContainer : EventTarget {
  readonly attribute ServiceWorker? controller;
  readonly attribute Promise&lt;ServiceWorkerRegistration&gt; ready;

  [NewObject] Promise&lt;ServiceWorkerRegistration&gt; register(USVString scriptURL, optional RegistrationOptions options);

  [NewObject] Promise&lt;any&gt; getRegistration(optional USVString clientURL = &quot;&quot;);
  [NewObject] Promise&lt;FrozenArray&lt;ServiceWorkerRegistration&gt;&gt; getRegistrations();

  void startMessages();


  // events
  attribute EventHandler oncontrollerchange;
  attribute EventHandler onmessage; // event.source of message events is ServiceWorker object
  attribute EventHandler onmessageerror;
};
</code></pre></div><ul><li><p>ServiceWorkerContainer.controller</p> <p>当ServiceWorker的state是active时，返回一个ServiceWorker对象（和ServiceWorkerRegisteration.active）返回的对象相同。如果当前的state不是active或强制刷新浏览器则返回null</p></li> <li><p>ServiceWorkerContainer.ready</p> <p>定义serviceWorker是否准备好为一个页面服务，返回一个Promise对象。当ServiceWorkerRegistration获取到一个active的ServiceWorker时被解决</p></li> <li><p>register(scriptURL, options)</p></li> <li><p>onmessage</p></li></ul> <h4 id="navigationpreloadmanager"><a href="#navigationpreloadmanager" aria-hidden="true" class="header-anchor">#</a> NavigationPreloadManager</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface NavigationPreloadManager {
  Promise&lt;void&gt; enable();
  Promise&lt;void&gt; disable();
  Promise&lt;void&gt; setHeaderValue(ByteString value);
  Promise&lt;NavigationPreloadState&gt; getState();
};

dictionary NavigationPreloadState {
  boolean enabled = false;
  ByteString headerValue;
};
</code></pre></div><ul><li><p>enable()</p> <p>触发时，返回promise对象并且对注册表添加navigation preload enabled标签</p></li> <li><p>diable()</p> <p>触发时，返回promise对象并且取消navigation preload enabled标签</p></li> <li><p>setHeaderValue(value)</p> <p>设置Service-Worker-Navigation-Preload头并返回一个空Promise</p></li> <li><p>getState()</p></li></ul> <p>例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> event <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>navigationPreload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>navigationPreload<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Preloaded Response</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> event <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从缓存中读响应</span>
        <span class="token keyword">const</span> cachedResponse <span class="token operator">=</span> <span class="token keyword">await</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedResponse<span class="token punctuation">)</span> <span class="token keyword">return</span> cachedResponse<span class="token punctuation">;</span>
        <span class="token comment">// else 使用preloaded响应</span>
        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> event<span class="token punctuation">.</span>preloadedResponse<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token comment">// else 网络请求</span>
        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="serviceworkerglobalscope"><a href="#serviceworkerglobalscope" aria-hidden="true" class="header-anchor">#</a> ServiceWorkerGlobalScope</h4> <p>ServiceWorker的全局执行上下文</p> <div class="language-c# extra-class"><pre class="language-text"><code>[Global=(Worker,ServiceWorker), Exposed=ServiceWorker]
interface ServiceWorkerGlobalScope : WorkerGlobalScope {
  [SameObject] readonly attribute Clients clients;
  [SameObject] readonly attribute ServiceWorkerRegistration registration;

  [NewObject] Promise&lt;void&gt; skipWaiting();

  attribute EventHandler oninstall;
  attribute EventHandler onactivate;
  attribute EventHandler onfetch;

  // event
  attribute EventHandler onmessage; // event.source of the message events is Client object
  attribute EventHandler onmessageerror;
};
</code></pre></div><ul><li><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Clients" target="_blank" rel="noopener noreferrer">Clients<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>skipWaiting()</p> <p>允许service worker直接从registration的waiting阶段跳到active阶段</p></li></ul> <h4 id="client"><a href="#client" aria-hidden="true" class="header-anchor">#</a> Client</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[Exposed=ServiceWorker]
interface Client {
  readonly attribute USVString url;
  readonly attribute FrameType frameType;
  readonly attribute DOMString id;
  readonly attribute ClientType type;
  void postMessage(any message, optional sequence&lt;object&gt; transfer = []);
};

[Exposed=ServiceWorker]
interface WindowClient : Client {
  readonly attribute VisibilityState visibilityState;
  readonly attribute boolean focused;
  [SameObject] readonly attribute FrozenArray&lt;USVString&gt; ancestorOrigins;
  [NewObject] Promise&lt;WindowClient&gt; focus();
  [NewObject] Promise&lt;WindowClient?&gt; navigate(USVString url);
};

enum FrameType {
  &quot;auxiliary&quot;,
  &quot;top-level&quot;,
  &quot;nested&quot;,
  &quot;none&quot;
};
</code></pre></div><p>Client对象即service worker client。带有一个frame type，包括auxiliary、top-level、nested和none</p> <ul><li>postMessage(message, transfer)</li></ul> <h4 id="clients"><a href="#clients" aria-hidden="true" class="header-anchor">#</a> Clients</h4> <div class="language-c# extra-class"><pre class="language-text"><code>[Exposed=ServiceWorker]
interface Clients {
  // The objects returned will be new instances every time
  [NewObject] Promise&lt;any&gt; get(DOMString id);
  [NewObject] Promise&lt;FrozenArray&lt;Client&gt;&gt; matchAll(optional ClientQueryOptions options);
  [NewObject] Promise&lt;WindowClient?&gt; openWindow(USVString url);
  [NewObject] Promise&lt;void&gt; claim();
};
</code></pre></div><p>当用户代理创建了ServiceWorkerGlobalScope对象时，必须创建一个Clients对象</p> <ul><li><p>claim()</p> <p>允许激活的service worker设置自己</p></li></ul> <h4 id="event"><a href="#event" aria-hidden="true" class="header-anchor">#</a> Event</h4> <h5 id="extendableevent"><a href="#extendableevent" aria-hidden="true" class="header-anchor">#</a> ExtendableEvent</h5> <div class="language-c# extra-class"><pre class="language-text"><code>[Constructor(DOMString type, optional ExtendableEventInit eventInitDict), Exposed=ServiceWorker]
interface ExtendableEvent : Event {
  void waitUntil(Promise&lt;any&gt; f);
};
</code></pre></div><p>event.waitUntil(f)</p> <h5 id="fetchevent"><a href="#fetchevent" aria-hidden="true" class="header-anchor">#</a> FetchEvent</h5> <div class="language-c# extra-class"><pre class="language-text"><code>[Constructor(DOMString type, FetchEventInit eventInitDict), Exposed=ServiceWorker]
interface FetchEvent : ExtendableEvent {
  [SameObject] readonly attribute Request request;
  readonly attribute Promise&lt;any&gt; preloadResponse;
  readonly attribute DOMString clientId;
  readonly attribute DOMString resultingClientId;
  readonly attribute DOMString replacesClientId;

  void respondWith(Promise&lt;Response&gt; r);
};
</code></pre></div><h5 id="events"><a href="#events" aria-hidden="true" class="header-anchor">#</a> Events</h5> <p><strong>install</strong>: Service Worker安装成功后被触发的事件，在事件处理函数中可以添加需要缓存的文件</p> <p><strong>activate</strong>: 当Service Worker安装完成后并进入激活状态，会触发activate事件。通过监听activate事件可以做一些预处理，如对旧版本的更新、对无用缓存的清理等</p> <p><strong>message</strong>: Service Worker运行于独立context中，无法直接访问当前页面主线程的DOM等信息，但是通过postMessage API，可以实现消息的传递，这样主线程就可以接受Service Worker的指令操作DOM</p> <p><strong>fetch</strong>(请求): 当浏览器在当前指定的scope下发起请求时，会触发fetch事件，并得到传有response参数的回调函数，回调中就可以做各种代理缓存的事情</p> <p><strong>push</strong>(推送): push事件是为推送准备的。依赖于Notification API和PUSH API。通过PUSH API，当订阅了推送服务后，可以使用推送方式唤醒Service Worker以响应来自系统消息传递服务的消息，即使<strong>用户已经关闭了页面</strong></p> <p><strong>sync</strong>(后台同步): sync事件由background sync（后台）同步发出。background sync配合Service Worker推出的API，用于为Service Worker提供一个可以实现注册和监听同步处理的方法。但<strong>还不在W3C Web API标准中</strong></p> <p><strong>notificationclick</strong></p> <p><strong>notificationclose</strong></p> <p><strong>canmakepayment</strong></p> <p><strong>paymentrequest</strong></p> <p><strong>messageerror</strong></p> <h3 id="caches"><a href="#caches" aria-hidden="true" class="header-anchor">#</a> Caches</h3> <div class="language-c# extra-class"><pre class="language-text"><code>[SecureContext, Exposed=(Window,Worker)]
interface Cache {
  [NewObject] Promise&lt;any&gt; match(RequestInfo request, optional CacheQueryOptions options);
  [NewObject] Promise&lt;FrozenArray&lt;Response&gt;&gt; matchAll(optional RequestInfo request, optional CacheQueryOptions options);
  [NewObject] Promise&lt;void&gt; add(RequestInfo request);
  [NewObject] Promise&lt;void&gt; addAll(sequence&lt;RequestInfo&gt; requests);
  [NewObject] Promise&lt;void&gt; put(RequestInfo request, Response response);
  [NewObject] Promise&lt;boolean&gt; delete(RequestInfo request, optional CacheQueryOptions options);
  [NewObject] Promise&lt;FrozenArray&lt;Request&gt;&gt; keys(optional RequestInfo request, optional CacheQueryOptions options);
};
</code></pre></div><h3 id="security-considerations"><a href="#security-considerations" aria-hidden="true" class="header-anchor">#</a> Security Considerations</h3> <h4 id="secure-context"><a href="#secure-context" aria-hidden="true" class="header-anchor">#</a> Secure Context</h4> <p>Service workers必须执行在secure contexts中。因此service workers和他的service worker clients需要在HTTPS域中。同样也允许在localhost，127.0.0.0/8，::1/128供开发使用。</p> <h4 id="importscripts-urls"><a href="#importscripts-urls" aria-hidden="true" class="header-anchor">#</a> importScripts(urls)</h4> <p>当被ServiceWorkerGlobalScope对象调用执行该方法时，必将import 脚本到worker global scope中，给到ServiceWorkerGlobalScope对象和urls，并对每个请求执行fetch操作</p> <h3 id="service-worker与页面通信"><a href="#service-worker与页面通信" aria-hidden="true" class="header-anchor">#</a> Service Worker与页面通信</h3> <p>Service Worker没有直接操作页面DOM的权限，但是可以通过postMessage方法和Web页面进行通信，让页面操作DOM</p> <ol><li><p><strong>Client</strong>:postMessage(message, transfer)</p> <p>在<code>sw.js</code>中向页面发信息，可以采用client.postMessage()方法</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>clients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>clients <span class="token operator">&amp;&amp;</span> clients<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 发送字符串'sw.update'</span>
            client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'sw.update'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>ServiceWorkerContainer</strong>: onmessage()</p> <p>在页面中接收<code>sw.js</code>发来的信息，通过event.data来读取数据</p> <div class="language-js extra-class"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">'sw.update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 此处可以操作页面的DOM元素</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>ServiceWorker</strong>:postMessage(message, transfer)</p> <p>在主页面给ServiceWorker发消息，可以采用navigation.serviceWorker.controller.postMessage()方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 点击指定DOM时给Service Worker发送消息</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app-refresh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller <span class="token operator">&amp;&amp;</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'sw.updatedone'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p><strong>ServiceWorkerGlobalScope</strong>: onmessage()</p> <p>在<code>sw.js</code>中接收主页面发来的信息，通过event.data来读取数据</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出：'sw.updatedone'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p>同样可以使用MessageChannel创建一个信道，并在这个信道的两个MessagePort属性来传递数据。</p> <p>以https://googlechrome.github.io/samples/service-worker/post-message/为例</p> <p>截取service-worker.js 通讯相关部分：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// This is a somewhat contrived example of using client.postMessage() to originate a message from</span>
<span class="token comment">// the service worker to each client (i.e. controlled page).</span>
<span class="token comment">// Here, we send a message when the service worker starts up, prior to when it's ready to start</span>
<span class="token comment">// handling events.</span>
self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>clients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clients<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'The service worker just started up.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Handling message event:'</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
      <span class="token comment">// This command adds a new request/response pair to the cache.</span>
      <span class="token keyword">case</span> <span class="token string">'add'</span><span class="token punctuation">:</span>
        <span class="token comment">// If event.data.url isn't a valid URL, new Request() will throw a TypeError which will be handled</span>
        <span class="token comment">// by the outer .catch().</span>
        <span class="token comment">// Hardcode {mode: 'no-cors} since the default for new Requests constructed from strings is to require</span>
        <span class="token comment">// CORS, and we don't have any way of knowing whether an arbitrary URL that a user entered supports CORS.</span>
        <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>mode<span class="token punctuation">:</span> <span class="token string">'no-cors'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          event<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            error<span class="token punctuation">:</span> <span class="token keyword">null</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If the promise rejects, handle it by returning a standardized error message to the controlled page.</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Message handling failed:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

    event<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token punctuation">:</span> error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Beginning in Chrome 51, event is an ExtendableMessageEvent, which supports</span>
  <span class="token comment">// the waitUntil() method for extending the lifetime of the event handler</span>
  <span class="token comment">// until the promise is resolved.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'waitUntil'</span> <span class="token keyword">in</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Without support for waitUntil(), there's a chance that if the promise chain</span>
  <span class="token comment">// takes &quot;too long&quot; to execute, the service worker might be automatically</span>
  <span class="token comment">// stopped before it's complete.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">showCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#add'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      command<span class="token punctuation">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
      url<span class="token punctuation">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#url'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// If the promise resolves, just display a success message.</span>
      ChromeSamples<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">'Added to cache.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>ChromeSamples<span class="token punctuation">.</span>setStatus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// If the promise rejects, show the error.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// This wraps the message posting/response in a promise, which will resolve if the response doesn't</span>
  <span class="token comment">// contain an error, and reject with the error if it does. If you'd prefer, it's possible to call</span>
  <span class="token comment">// controller.postMessage() and set up the onmessage handler independently of a promise, but this is</span>
  <span class="token comment">// a convenient wrapper.</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> messageChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    messageChannel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// This sends the message data as well as transferring messageChannel.port2 to the service worker.</span>
    <span class="token comment">// The service worker can then use the transferred port to reply via postMessage(), which</span>
    <span class="token comment">// will in turn trigger the onmessage handler on messageChannel.port1.</span>
    <span class="token comment">// See https://html.spec.whatwg.org/multipage/workers.html#dom-worker-postmessage</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span>
      <span class="token punctuation">[</span>messageChannel<span class="token punctuation">.</span>port2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Set up a listener for messages posted from the service worker.</span>
  <span class="token comment">// The service worker is set to post a message to all its clients once it's run its activation</span>
  <span class="token comment">// handler and taken control of the page, so you should see this message event fire once.</span>
  <span class="token comment">// You can force it to fire again by visiting this page in an Incognito window.</span>
  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ChromeSamples<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'service-worker.js'</span><span class="token punctuation">)</span>
    <span class="token comment">// Wait until the service worker is active.</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// ...and then show the interface for the commands once it's ready.</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>showCommands<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Something went wrong during registration. The service-worker.js file</span>
      <span class="token comment">// might be unavailable or contain a syntax error.</span>
      ChromeSamples<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  ChromeSamples<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">'This browser does not support service workers.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="appmanifest"><a href="#appmanifest" aria-hidden="true" class="header-anchor">#</a> appmanifest</h2></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/My-lab/knowledge/Damn-hole-of-CSS3.html">
          CSS3
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/My-lab/assets/js/14.7df31e72.js" defer></script><script src="/My-lab/assets/js/app.e689323a.js" defer></script>
  </body>
</html>
